import{r as d,z as M,c as l,d as t,m as D,q as T,v as B,D as C,F as S,g as $,n as b,t as v,h as n}from"./app-a93a371e.js";import{c as H,e as N}from"./common-e70f09ed.js";const V={class:"container mx-auto px-4 py-8"},j={class:"max-w-7xl mx-auto"},q={class:"bg-white rounded-2xl shadow p-6"},z={class:"flex flex-col md:flex-row items-stretch md:items-end gap-3 mb-6"},F={class:"flex-1"},K={id:"earth-data-stats-list"},L=["value"],U={key:0,class:"text-gray-500"},O={key:1,class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},W={class:"bg-white border rounded-xl p-4"},G={class:"flex items-center gap-6"},J={class:"text-sm"},Q={class:"flex items-center gap-2 mb-1"},R={class:"flex items-center gap-2 mb-1"},X={class:"flex items-center gap-2"},Y={class:"bg-white border rounded-xl p-4"},Z={key:0,class:"text-gray-500"},tt={key:1,class:"w-full"},st={class:"w-full h-[220px] border-b border-gray-200 flex flex-wrap items-end"},et=["title"],at={class:"mt-2 text-[10px] text-gray-500"},A=220,lt=48,dt={__name:"EarthStatistics",setup(nt){const p=d("all"),u=d(""),g=d([]),f=d(null),i=d({total:0,verified:0,pending:0}),c=d([]);let y=null;const h=()=>{clearTimeout(y),y=setTimeout(w,400)},w=async()=>{try{const e=await H.earthDataDatalist({status:p.value,q:u.value});e.status&&(g.value=Array.isArray(e.data)?e.data:[])}catch{}},_=async()=>{var r,x;const e=(u.value||"").trim();if(!e)return;const s=e.split("｜")[0].trim(),a=parseInt(s,10);if(Number.isNaN(a))return;const o=await N.get(a);if(o.status){f.value=o.data;const m=await N.usageStats(a);m.status&&(i.value=((r=m.data)==null?void 0:r.totals)||{total:0,verified:0,pending:0},c.value=Array.isArray((x=m.data)==null?void 0:x.daily)?m.data.daily:[])}},I=M(()=>{const e=Math.max(0,Number(i.value.total)||0),s=Math.max(0,Math.min(e,Number(i.value.verified)||0)),a=Math.max(0,Math.min(e,Number(i.value.pending)||0)),o=e?s/e*100:0,r=e?a/e*100:0;return{background:`conic-gradient(#60a5fa 0 ${o}%, #fbbf24 ${o}% ${o+r}%, #e5e7eb ${o+r}% 100%)`}}),k=M(()=>Math.max(1,...c.value.map(e=>e.count||0))),E=e=>{const s=A-60;return k.value?Math.round(Math.max(0,e)/k.value*s):0},P=e=>(e||"").slice(5);return w(),(e,s)=>(n(),l("div",V,[t("div",j,[t("div",q,[s[13]||(s[13]=t("div",{class:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"},[t("div",null,[t("h2",{class:"text-2xl font-bold text-gray-800 mb-2"},"土單使用統計表"),t("p",{class:"text-gray-600"},"篩選工程並查看統計圖表")])],-1)),t("div",z,[t("div",null,[s[3]||(s[3]=t("label",{class:"block text-xs text-gray-500 mb-1"},"狀態",-1)),D(t("select",{"onUpdate:modelValue":s[0]||(s[0]=a=>p.value=a),onChange:h,class:"px-3 py-2 border rounded-md"},[...s[2]||(s[2]=[t("option",{value:"all"},"全部",-1),t("option",{value:"active"},"啟用中",-1),t("option",{value:"inactive"},"已結案",-1)])],544),[[T,p.value]])]),t("div",F,[s[4]||(s[4]=t("label",{class:"block text-xs text-gray-500 mb-1"},"選擇工程（可搜尋）",-1)),D(t("input",{"onUpdate:modelValue":s[1]||(s[1]=a=>u.value=a),onInput:h,onKeyup:C(_,["enter"]),list:"earth-data-stats-list",placeholder:"輸入關鍵字（批號/工程/客戶）後從下拉選擇",class:"w-full px-3 py-2 border rounded-md"},null,544),[[B,u.value]]),t("datalist",K,[(n(!0),l(S,null,$(g.value,a=>(n(),l("option",{key:a.id,value:`${a.id}｜${a.text}`},null,8,L))),128))])]),t("div",{class:"flex gap-2"},[t("button",{onClick:_,class:"px-4 py-2 bg-amber-600 text-white rounded-md"},"載入")])]),f.value?(n(),l("div",O,[t("div",W,[s[11]||(s[11]=t("h3",{class:"font-medium mb-3"},"總覽",-1)),t("div",G,[t("div",{class:"w-40 h-40 rounded-full",style:b(I.value),"aria-label":"usage pie"},null,4),t("div",J,[t("div",Q,[s[5]||(s[5]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#60a5fa"}},null,-1)),s[6]||(s[6]=t("span",null,"已核銷：",-1)),t("strong",null,v(i.value.verified),1)]),t("div",R,[s[7]||(s[7]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#fbbf24"}},null,-1)),s[8]||(s[8]=t("span",null,"待使用：",-1)),t("strong",null,v(i.value.pending),1)]),t("div",X,[s[9]||(s[9]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#e5e7eb"}},null,-1)),s[10]||(s[10]=t("span",null,"總數：",-1)),t("strong",null,v(i.value.total),1)])])])]),t("div",Y,[s[12]||(s[12]=t("h3",{class:"font-medium mb-3"},"每日使用統計",-1)),c.value.length===0?(n(),l("div",Z,"無資料")):(n(),l("div",tt,[t("div",st,[(n(!0),l(S,null,$(c.value,(a,o)=>(n(),l("div",{key:a.day,class:"flex flex-col items-center justify-end",style:b({width:lt+"px",height:A+"px"})},[t("div",{class:"w-6 bg-blue-400 rounded-t",style:b({height:E(a.count)+"px"}),title:`${a.day}: ${a.count}`},null,12,et),t("div",at,v(P(a.day)),1)],4))),128))])]))])])):(n(),l("div",U,"請先選擇工程"))])])]))}};export{dt as default};
