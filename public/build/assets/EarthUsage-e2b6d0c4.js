import{h as vt,i as r,y as ct,j as pt,c as l,a as e,k as m,n as Q,v as F,D as mt,F as j,l as K,f as c,g as $,t as d,M as O,b as W,o as n,N as xt,A as ft,e as C,O as gt}from"./app-c9b46d18.js";import{c as X,e as U}from"./common-3afdf093.js";import{P as yt}from"./PrintDialog-5cbd6451.js";import{f as Y,a as R}from"./date-0a728d64.js";const bt={class:"container mx-auto px-4 py-8"},_t={class:"max-w-6xl mx-auto"},ht={class:"bg-white rounded-xl shadow p-6"},kt={class:"flex flex-col md:flex-row items-stretch md:items-end gap-3 mb-6"},wt={class:"flex-1"},Dt={class:"flex gap-2"},$t={id:"earth-data-list"},St=["value"],Ct={class:"flex gap-2"},Ut={class:"flex items-center justify-between mb-4"},Vt={class:"flex items-center gap-4"},At={key:0,class:"flex items-center gap-2"},Nt=["value"],Tt={key:0,class:"flex gap-4 text-sm"},Mt={class:"flex items-center gap-1"},Pt={class:"font-semibold text-gray-900"},It={class:"flex items-center gap-1"},Lt={class:"font-semibold text-blue-600"},Bt={class:"flex items-center gap-1"},Et={class:"font-semibold text-green-600"},Ft={class:"flex items-center gap-1"},jt={class:"font-semibold text-red-600"},Kt={class:"flex items-center gap-1"},Ot={class:"font-semibold text-orange-600"},Rt={key:0,class:"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200"},qt={class:"flex flex-col gap-4"},zt={class:"flex items-center gap-4"},Gt={class:"flex items-center gap-2"},Ht={class:"inline-flex items-center gap-2 cursor-pointer"},Jt={class:"inline-flex items-center gap-2 cursor-pointer"},Qt={class:"inline-flex items-center gap-2 cursor-pointer"},Wt={class:"text-sm text-gray-600"},Xt={class:"font-semibold text-amber-600"},Yt=["disabled"],Zt={key:0,class:"fas fa-spinner fa-spin mr-2"},te={key:0,class:"flex items-center gap-4 pt-2 border-t border-gray-300"},ee={class:"flex items-center gap-2"},se={class:"flex items-center gap-2"},ae=["min"],le={key:1,class:"text-gray-500"},ne={key:2,class:"border rounded-md max-h-[60vh] overflow-auto"},oe={class:"min-w-full text-sm"},ie={class:"bg-gray-50"},ue={class:"px-3 py-2 text-left w-12"},re=["checked"],de={class:"px-3 py-2"},ve=["value"],ce={key:1,class:"text-xs text-gray-400"},pe={class:"px-3 py-2 font-mono"},me={class:"px-3 py-2"},xe={class:"px-3 py-2"},fe={class:"px-3 py-2"},ge={class:"px-3 py-2"},ye={key:0},be={key:0,class:"font-medium"},_e={key:1,class:"text-xs text-gray-500"},he={key:1,class:"text-gray-400"},ke={class:"px-3 py-2"},we={key:0},De={key:0,class:"font-medium"},$e={key:1,class:"text-xs text-gray-500"},Se={key:1,class:"text-gray-400"},Ce={class:"px-3 py-2"},Ue={class:"px-3 py-2"},Ve={key:1,class:"text-xs text-gray-400"},Ae={key:0},Ne={key:1},Te={key:2},Me={key:3},Pe={key:0},je={__name:"EarthUsage",setup(Ie){const{success:T,error:p}=vt(),M=r("all"),_=r(""),q=r([]),i=r(null),h=r([]),x=r(null),S=r(null),P=r([]),u=r([]),v=r(""),f=r(""),g=r(""),y=r(!1),V=r(!1),A=r(null),N=r({total:0,verified:0,pending:0}),k=r(1),I=r(!1);let z=null;const G=()=>{clearTimeout(z),z=setTimeout(L,400)},L=async()=>{try{const a=await X.earthDataDatalist({status:M.value,q:_.value});a.status&&(q.value=Array.isArray(a.data)?a.data:[])}catch{}},Z=()=>{const a=(_.value||"").trim();a&&a.includes("｜")&&H()},H=async()=>{const a=(_.value||"").trim();if(!a)return;const t=a.split("｜")[0].trim(),s=parseInt(t,10);if(Number.isNaN(s))return;const o=await U.get(s);o.status&&(i.value=o.data,await w(s))},w=async a=>{var o,b;const t={};S.value!==null&&(t.status=S.value);const s=await U.details(a,t);s.status&&(h.value=Array.isArray((o=s.data)==null?void 0:o.details)?s.data.details:[],x.value=((b=s.data)==null?void 0:b.stats)||null,u.value=[],v.value="",f.value="",g.value="")},tt=()=>{i.value=null,_.value="",h.value=[],x.value=null,u.value=[],v.value="",f.value="",g.value="",S.value=null,L()},et=async()=>{var a;(a=i.value)!=null&&a.id&&(await w(i.value.id),T("明細資料已更新"))},st=()=>{var o;if(!((o=i.value)!=null&&o.id))return;const a=localStorage.getItem("token")||"",t=`/api/earth-data/${i.value.id}/details/export`,s=a?`${t}?token=${encodeURIComponent(a)}`:t;window.open(s,"_blank")},B=a=>a!==3&&a!==4&&a!==2,J=ct(()=>{const a=h.value.filter(t=>B(t.status));return a.length===0?!1:a.every(t=>u.value.includes(t.id))}),at=()=>{const a=h.value.filter(t=>B(t.status));if(J.value)u.value=u.value.filter(t=>!a.some(s=>s.id===t));else{const t=a.map(s=>s.id);u.value=[...new Set([...u.value,...t])]}},lt=async a=>{var t;if(a){A.value=a,k.value=1,N.value={total:0,verified:0,pending:0},V.value=!0,I.value=!0;try{const s=await U.usageStats(a);if(s.status){const o=((t=s.data)==null?void 0:t.totals)||{},b=Number(o.total??0),D=Number(o.verified??0),E=Math.max(0,b-D);N.value={total:b,verified:D,pending:E},k.value>E&&(k.value=E||1)}else p(s.message||"取得統計失敗")}catch(s){p(s.message||"取得統計失敗")}finally{I.value=!1}}},nt=()=>{V.value=!1,A.value=null},ot=()=>{const a=Number(N.value.pending||0);let t=Number(k.value||0);if(!A.value)return;if(!Number.isFinite(t)||t<=0){p("請輸入正確的列印數量");return}if(t>a){p(`本次列印數量不可超過未印數量（${a}）`);return}const s=`/print/earth-data/${A.value}/pending?count=${t}`;window.open(s,"_blank"),nt(),setTimeout(()=>{var o;(o=i.value)!=null&&o.id&&w(i.value.id)},1e3)},it=async()=>{var a,t,s;if((a=i.value)!=null&&a.id){if(!v.value||u.value.length===0){p("請選擇動作和要處理的明細");return}y.value=!0;try{if(v.value==="updateDates"){if(!f.value&&!g.value){p("請至少輸入一個日期"),y.value=!1;return}if(!confirm(`確定要更新選中的 ${u.value.length} 筆明細的使用期限嗎？`)){y.value=!1;return}const o=await U.batchUpdateDates(i.value.id,u.value,f.value||null,g.value||null);o.status?(T(`成功更新 ${((t=o.data)==null?void 0:t.updated_count)||u.value.length} 筆明細的使用期限`),await w(i.value.id),f.value="",g.value=""):p(o.message||"更新期限失敗")}else{const o=v.value==="void"?"作廢":"回收";if(!confirm(`確定要${o}選中的 ${u.value.length} 筆明細嗎？`)){y.value=!1;return}const b=v.value==="void"?3:4,D=await U.batchUpdateStatus(i.value.id,u.value,b);D.status?(T(`成功${o} ${((s=D.data)==null?void 0:s.updated_count)||u.value.length} 筆明細`),await w(i.value.id)):p(D.message||`${o}失敗`)}}catch(o){p("操作失敗："+(o.message||"未知錯誤"))}finally{y.value=!1}}},ut=a=>{const t=P.value.find(s=>s.value===a);return(t==null?void 0:t.label)||"未知"},rt=a=>{const t="px-2 py-1 text-xs rounded font-medium";switch(a){case 0:return`${t} bg-gray-100 text-gray-700`;case 1:return`${t} bg-blue-100 text-blue-700`;case 2:return`${t} bg-green-100 text-green-700`;case 3:return`${t} bg-red-100 text-red-700`;case 4:return`${t} bg-orange-100 text-orange-700`;default:return`${t} bg-gray-100 text-gray-700`}},dt=async()=>{try{const a=await X.earthDataDetailStatusList();a.status&&Array.isArray(a.data)&&(P.value=a.data)}catch(a){console.error("載入狀態列表失敗",a)}};return L(),pt(()=>{dt()}),(a,t)=>(n(),l("div",bt,[e("div",_t,[e("div",ht,[t[46]||(t[46]=e("h2",{class:"text-xl font-semibold mb-4"},"土單使用明細",-1)),e("div",kt,[e("div",null,[t[14]||(t[14]=e("label",{class:"block text-xs text-gray-500 mb-1"},"狀態",-1)),m(e("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>M.value=s),onChange:G,class:"px-3 py-2 border rounded-md"},[...t[13]||(t[13]=[e("option",{value:"all"},"全部",-1),e("option",{value:"active"},"啟用中",-1),e("option",{value:"inactive"},"已結案",-1)])],544),[[Q,M.value]])]),e("div",wt,[t[16]||(t[16]=e("label",{class:"block text-xs text-gray-500 mb-1"},"選擇工程（可搜尋）",-1)),e("div",Dt,[m(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>_.value=s),onInput:G,onChange:Z,onKeyup:mt(H,["enter"]),list:"earth-data-list",placeholder:"輸入關鍵字（批號/工程/客戶）後從下拉選擇",class:"flex-1 px-3 py-2 border rounded-md"},null,544),[[F,_.value]]),e("datalist",$t,[(n(!0),l(j,null,K(q.value,s=>(n(),l("option",{key:s.id,value:`${s.id}｜${s.text}`},null,8,St))),128))]),i.value?(n(),l("button",{key:0,onClick:tt,class:"px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors",title:"清除選擇"},[...t[15]||(t[15]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])):c("",!0)])]),e("div",Ct,[i.value?(n(),l("button",{key:0,onClick:et,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"},[...t[17]||(t[17]=[e("i",{class:"fas fa-sync-alt mr-2"},null,-1),$(" 重整 ",-1)])])):c("",!0),i.value?(n(),l("button",{key:1,onClick:st,class:"px-4 py-2 bg-emerald-600 text-white rounded-md"},"匯出")):c("",!0)])]),e("div",null,[e("div",Ut,[e("div",Vt,[t[19]||(t[19]=e("h3",{class:"font-medium"},"明細列表",-1)),i.value?(n(),l("div",At,[t[18]||(t[18]=e("label",{class:"text-sm text-gray-600"},"狀態篩選：",-1)),m(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>S.value=s),onChange:t[3]||(t[3]=s=>w(i.value.id)),class:"px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500"},[(n(!0),l(j,null,K(P.value,s=>(n(),l("option",{key:s.value,value:s.value},d(s.label),9,Nt))),128))],544),[[Q,S.value]])])):c("",!0)]),i.value&&x.value?(n(),l("div",Tt,[e("div",Mt,[t[20]||(t[20]=e("span",{class:"text-gray-600"},"總數量：",-1)),e("span",Pt,d(x.value.total||0),1)]),e("div",It,[t[21]||(t[21]=e("span",{class:"text-gray-600"},"已列印：",-1)),e("span",Lt,d(x.value.printed||0),1)]),e("div",Bt,[t[22]||(t[22]=e("span",{class:"text-gray-600"},"已核銷：",-1)),e("span",Et,d(x.value.used||0),1)]),e("div",Ft,[t[23]||(t[23]=e("span",{class:"text-gray-600"},"作廢：",-1)),e("span",jt,d(x.value.voided||0),1)]),e("div",Kt,[t[24]||(t[24]=e("span",{class:"text-gray-600"},"回收：",-1)),e("span",Ot,d(x.value.recycled||0),1)])])):c("",!0)]),i.value?(n(),l("div",Rt,[e("div",qt,[e("div",zt,[e("div",Gt,[t[28]||(t[28]=e("label",{class:"text-sm font-medium text-gray-700"},"動作選項：",-1)),e("label",Ht,[m(e("input",{type:"radio",value:"void","onUpdate:modelValue":t[4]||(t[4]=s=>v.value=s),class:"text-red-600 focus:ring-red-500"},null,512),[[O,v.value]]),t[25]||(t[25]=e("span",{class:"text-sm"},"作廢",-1))]),e("label",Jt,[m(e("input",{type:"radio",value:"recycle","onUpdate:modelValue":t[5]||(t[5]=s=>v.value=s),class:"text-orange-600 focus:ring-orange-500"},null,512),[[O,v.value]]),t[26]||(t[26]=e("span",{class:"text-sm"},"回收",-1))]),e("label",Qt,[m(e("input",{type:"radio",value:"updateDates","onUpdate:modelValue":t[6]||(t[6]=s=>v.value=s),class:"text-blue-600 focus:ring-blue-500"},null,512),[[O,v.value]]),t[27]||(t[27]=e("span",{class:"text-sm"},"更改期限",-1))])]),t[32]||(t[32]=e("div",{class:"flex-1"},null,-1)),e("div",Wt,[t[29]||(t[29]=$(" 已選擇 ",-1)),e("span",Xt,d(u.value.length),1),t[30]||(t[30]=$(" 筆 ",-1))]),e("button",{onClick:it,disabled:!v.value||u.value.length===0||y.value,class:"px-4 py-2 text-sm font-medium text-white bg-amber-600 rounded-md hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[y.value?(n(),l("i",Zt)):c("",!0),t[31]||(t[31]=$(" 確認 ",-1))],8,Yt)]),v.value==="updateDates"?(n(),l("div",te,[e("div",ee,[t[33]||(t[33]=e("label",{class:"text-sm font-medium text-gray-700"},"使用起始日期：",-1)),m(e("input",{type:"date","onUpdate:modelValue":t[7]||(t[7]=s=>f.value=s),class:"px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},null,512),[[F,f.value]])]),e("div",se,[t[34]||(t[34]=e("label",{class:"text-sm font-medium text-gray-700"},"使用結束日期：",-1)),m(e("input",{type:"date","onUpdate:modelValue":t[8]||(t[8]=s=>g.value=s),min:f.value,class:"px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,ae),[[F,g.value]])])])):c("",!0)])])):c("",!0),i.value?(n(),l("div",ne,[e("table",oe,[e("thead",ie,[e("tr",null,[e("th",ue,[e("input",{type:"checkbox",checked:J.value,onChange:at,class:"rounded border-gray-300 text-amber-600 focus:ring-amber-500"},null,40,re)]),t[35]||(t[35]=e("th",{class:"px-3 py-2 text-left"},"Barcode",-1)),t[36]||(t[36]=e("th",{class:"px-3 py-2 text-left"},"狀態",-1)),t[37]||(t[37]=e("th",{class:"px-3 py-2 text-left"},"使用起迄日",-1)),t[38]||(t[38]=e("th",{class:"px-3 py-2 text-left"},"列印時間",-1)),t[39]||(t[39]=e("th",{class:"px-3 py-2 text-left"},"核銷人員/時間",-1)),t[40]||(t[40]=e("th",{class:"px-3 py-2 text-left"},"車號/司機",-1)),t[41]||(t[41]=e("th",{class:"px-3 py-2 text-left"},"建立時間",-1)),t[42]||(t[42]=e("th",{class:"px-3 py-2 text-left"},"操作",-1))])]),e("tbody",null,[(n(!0),l(j,null,K(h.value,s=>(n(),l("tr",{key:s.id},[e("td",de,[B(s.status)?m((n(),l("input",{key:0,type:"checkbox",value:s.id,"onUpdate:modelValue":t[9]||(t[9]=o=>u.value=o),class:"rounded border-gray-300 text-amber-600 focus:ring-amber-500"},null,8,ve)),[[xt,u.value]]):(n(),l("span",ce,"-"))]),e("td",pe,d(s.barcode),1),e("td",me,[e("span",{class:ft(rt(s.status))},d(ut(s.status)),3)]),e("td",xe,[$(d(C(Y)(s.use_start_date)),1),t[43]||(t[43]=e("br",null,null,-1)),$(d(C(Y)(s.use_end_date)),1)]),e("td",fe,d(C(R)(s.print_at)),1),e("td",ge,[s.verified_at||s.verified_by_name?(n(),l("div",ye,[s.verified_by_name?(n(),l("div",be,d(s.verified_by_name),1)):c("",!0),s.verified_at?(n(),l("div",_e,d(C(R)(s.verified_at)),1)):c("",!0)])):(n(),l("span",he,"-"))]),e("td",ke,[s.vehicle_plate||s.driver_name?(n(),l("div",we,[s.vehicle_plate?(n(),l("div",De,d(s.vehicle_plate),1)):c("",!0),s.driver_name?(n(),l("div",$e,d(s.driver_name),1)):c("",!0)])):(n(),l("span",Se,"-"))]),e("td",Ce,d(C(R)(s.created_at)),1),e("td",Ue,[s.status!==3&&s.status!==4&&s.status!==2?(n(),l("button",{key:0,onClick:t[10]||(t[10]=o=>lt(i.value.id)),class:"action-btn action-btn--print",title:"列印未列印"},[...t[44]||(t[44]=[e("i",{class:"fas fa-print action-icon"},null,-1)])])):(n(),l("span",Ve,[s.status===3?(n(),l("span",Ae,"已作廢")):s.status===4?(n(),l("span",Ne,"已回收")):s.status===2?(n(),l("span",Te,"已核銷")):(n(),l("span",Me,"-"))]))])]))),128)),h.value.length===0?(n(),l("tr",Pe,[...t[45]||(t[45]=[e("td",{class:"px-3 py-6 text-center text-gray-500",colspan:"10"},"無明細",-1)])])):c("",!0)])])])):(n(),l("div",le,"請先選擇工程"))])])]),W(gt),W(yt,{modelValue:V.value,"onUpdate:modelValue":t[11]||(t[11]=s=>V.value=s),totals:N.value,loading:I.value,count:k.value,"onUpdate:count":t[12]||(t[12]=s=>k.value=s),onSubmit:ot},null,8,["modelValue","totals","loading","count"])]))}};export{je as default};
