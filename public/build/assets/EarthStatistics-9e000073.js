import{r as d,H as N,c as o,d as t,p as g,s as P,v as h,C as U,F as $,g as T,j,n as w,t as y,h as n}from"./app-9d7b164d.js";import{c as B,e as A}from"./common-02d6fdc0.js";const F={class:"container mx-auto px-4 py-8"},K={class:"max-w-7xl mx-auto"},L={class:"bg-white rounded-2xl shadow p-6"},O={class:"flex flex-col md:flex-row items-stretch md:items-end gap-3 mb-6"},q={class:"flex-1"},z={id:"earth-data-stats-list"},W=["value"],G={key:0,class:"flex flex-col md:flex-row items-stretch md:items-center gap-3 mb-6 p-4 bg-gray-50 rounded-lg"},J={key:1,class:"text-gray-500"},Q={key:2,class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},R={class:"bg-white border rounded-xl p-4"},X={class:"flex items-center gap-6"},Y={class:"text-sm"},Z={class:"flex items-center gap-2 mb-1"},tt={class:"flex items-center gap-2 mb-1"},et={class:"flex items-center gap-2"},st={class:"bg-white border rounded-xl p-4"},at={key:0,class:"text-gray-500"},lt={key:1,class:"w-full"},ot={class:"w-full h-[220px] border-b border-gray-200 flex flex-wrap items-end"},nt=["title"],dt={class:"mt-2 text-[10px] text-gray-500"},I=220,it=48,vt={__name:"EarthStatistics",setup(rt){const f=d("all"),c=d(""),k=d([]),u=d(null),i=d({total:0,verified:0,pending:0}),m=d([]),v=()=>new Date().toISOString().split("T")[0],p=d(v()),x=d(v());let _=null;const S=()=>{clearTimeout(_),_=setTimeout(M,400)},M=async()=>{try{const s=await B.earthDataDatalist({status:f.value,q:c.value});s.status&&(k.value=Array.isArray(s.data)?s.data:[])}catch{}},D=async()=>{const s=(c.value||"").trim();if(!s)return;const e=s.split("｜")[0].trim(),a=parseInt(e,10);if(Number.isNaN(a))return;const l=await A.get(a);l.status&&(u.value=l.data,p.value=v(),x.value=v(),await b())},b=async()=>{var s,e,a;if((s=u.value)!=null&&s.id)try{const l={date_from:p.value,date_to:x.value},r=await A.usageStats(u.value.id,l);r.status&&(i.value=((e=r.data)==null?void 0:e.totals)||{total:0,verified:0,pending:0},m.value=Array.isArray((a=r.data)==null?void 0:a.daily)?r.data.daily:[])}catch(l){console.error("載入統計失敗:",l)}},V=N(()=>{const s=Math.max(0,Number(i.value.total)||0),e=Math.max(0,Math.min(s,Number(i.value.verified)||0)),a=Math.max(0,Math.min(s,Number(i.value.pending)||0)),l=s?e/s*100:0,r=s?a/s*100:0;return{background:`conic-gradient(#60a5fa 0 ${l}%, #fbbf24 ${l}% ${l+r}%, #e5e7eb ${l+r}% 100%)`}}),C=N(()=>Math.max(1,...m.value.map(s=>s.count||0))),E=s=>{const e=I-60;return C.value?Math.round(Math.max(0,s)/C.value*e):0},H=s=>(s||"").slice(5);return M(),(s,e)=>(n(),o("div",F,[t("div",K,[t("div",L,[e[17]||(e[17]=t("div",{class:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"},[t("div",null,[t("h2",{class:"text-2xl font-bold text-gray-800 mb-2"},"土單使用統計表"),t("p",{class:"text-gray-600"},"篩選工程並查看統計圖表")])],-1)),t("div",O,[t("div",null,[e[5]||(e[5]=t("label",{class:"block text-xs text-gray-500 mb-1"},"狀態",-1)),g(t("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>f.value=a),onChange:S,class:"px-3 py-2 border rounded-md"},[...e[4]||(e[4]=[t("option",{value:"all"},"全部",-1),t("option",{value:"active"},"啟用中",-1),t("option",{value:"inactive"},"已結案",-1)])],544),[[P,f.value]])]),t("div",q,[e[6]||(e[6]=t("label",{class:"block text-xs text-gray-500 mb-1"},"選擇工程（可搜尋）",-1)),g(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>c.value=a),onInput:S,onKeyup:U(D,["enter"]),list:"earth-data-stats-list",placeholder:"輸入關鍵字（批號/工程/客戶）後從下拉選擇",class:"w-full px-3 py-2 border rounded-md"},null,544),[[h,c.value]]),t("datalist",z,[(n(!0),o($,null,T(k.value,a=>(n(),o("option",{key:a.id,value:`${a.id}｜${a.text}`},null,8,W))),128))])]),t("div",{class:"flex gap-2"},[t("button",{onClick:D,class:"px-4 py-2 bg-amber-600 text-white rounded-md"},"載入")])]),u.value?(n(),o("div",G,[t("div",null,[e[7]||(e[7]=t("label",{class:"block text-xs text-gray-500 mb-1"},"使用起始日期",-1)),g(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>p.value=a),type:"date",onChange:b,class:"px-3 py-2 border rounded-md"},null,544),[[h,p.value]])]),t("div",null,[e[8]||(e[8]=t("label",{class:"block text-xs text-gray-500 mb-1"},"使用結束日期",-1)),g(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>x.value=a),type:"date",onChange:b,class:"px-3 py-2 border rounded-md"},null,544),[[h,x.value]])]),t("button",{onClick:b,class:"md:mt-5 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"}," 更新統計 ")])):j("",!0),u.value?(n(),o("div",Q,[t("div",R,[e[15]||(e[15]=t("h3",{class:"font-medium mb-3"},"總覽",-1)),t("div",X,[t("div",{class:"w-40 h-40 rounded-full",style:w(V.value),"aria-label":"usage pie"},null,4),t("div",Y,[t("div",Z,[e[9]||(e[9]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#60a5fa"}},null,-1)),e[10]||(e[10]=t("span",null,"已核銷：",-1)),t("strong",null,y(i.value.verified),1)]),t("div",tt,[e[11]||(e[11]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#fbbf24"}},null,-1)),e[12]||(e[12]=t("span",null,"待使用：",-1)),t("strong",null,y(i.value.pending),1)]),t("div",et,[e[13]||(e[13]=t("span",{class:"inline-block w-3 h-3 rounded-sm",style:{background:"#e5e7eb"}},null,-1)),e[14]||(e[14]=t("span",null,"總數：",-1)),t("strong",null,y(i.value.total),1)])])])]),t("div",st,[e[16]||(e[16]=t("h3",{class:"font-medium mb-3"},"每日使用統計",-1)),m.value.length===0?(n(),o("div",at,"無資料")):(n(),o("div",lt,[t("div",ot,[(n(!0),o($,null,T(m.value,(a,l)=>(n(),o("div",{key:a.day,class:"flex flex-col items-center justify-end",style:w({width:it+"px",height:I+"px"})},[t("div",{class:"w-6 bg-blue-400 rounded-t",style:w({height:E(a.count)+"px"}),title:`${a.day}: ${a.count}`},null,12,nt),t("div",dt,y(H(a.day)),1)],4))),128))])]))])])):(n(),o("div",J,"請先選擇工程"))])])]))}};export{vt as default};
