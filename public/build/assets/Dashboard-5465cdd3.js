import{_ as me,Q as ve,b as xe,r as n,H as ge,o as pe,R as ye,c as o,e as k,d as e,j as I,t as i,f as x,q as F,p as G,v as oe,i as $,F as K,g as Q,s as be,k as he,x as we,h as l,O as _e}from"./app-9d7b164d.js";import{v as M,u as ke}from"./useAuth-8aaf39f9.js";import{f as Se}from"./date-69680232.js";const Y="verifier_offline_records";function W(){try{const f=localStorage.getItem(Y);return f?JSON.parse(f):[]}catch(f){return console.error("讀取離線記錄失敗:",f),[]}}function Ce(f){try{const r=W(),d=Date.now(),m={id:d,...f,created_at:new Date().toISOString(),status:"pending"};return r.push(m),localStorage.setItem(Y,JSON.stringify(r)),d}catch(r){throw console.error("儲存離線記錄失敗:",r),r}}function le(){return W().filter(r=>r.status==="pending")}function re(f,r){try{const d=W(),m=d.findIndex(j=>j.id===f);return m===-1?!1:(d[m].status=r,d[m].updated_at=new Date().toISOString(),localStorage.setItem(Y,JSON.stringify(d)),!0)}catch(d){return console.error("更新記錄狀態失敗:",d),!1}}class Re{async preCheck(r){return await M.post("/verifier-platform/verify/pre-check",{barcode:r})}async verify(r,d=null,m=null){return await M.post("/verifier-platform/verify",{barcode:r,vehicle_id:d,driver_name:m})}async batchVerify(r){return await M.post("/verifier-platform/verify/batch",{barcodes:r})}async getStats(){return await M.get("/verifier-platform/verify/stats")}}const q=new Re;const Ve={class:"min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 pb-20"},Oe={key:0,class:"fixed top-0 left-0 right-0 bg-amber-500 text-white px-4 py-3 text-center z-50 shadow-md"},Te={class:"bg-white shadow-sm sticky top-0 z-40"},Ie={class:"container mx-auto px-4 py-3 sm:py-4"},je={class:"flex items-center justify-between"},De={class:"flex items-center gap-3"},Be={key:0,class:"flex items-center gap-2 px-3 py-2 text-sm text-gray-700"},Ne={class:"font-medium"},ze={class:"container mx-auto px-4 py-4 sm:py-6"},Ae={class:"max-w-2xl mx-auto mb-6"},Ee={class:"bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6"},$e={class:"flex gap-2"},Me=["disabled"],qe=["disabled"],Le={key:0,class:"flex items-center justify-center"},Pe={key:1,class:"flex items-center justify-center"},Ue={class:"max-w-2xl mx-auto mb-6"},He={class:"grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4"},Je={class:"bg-white rounded-lg shadow p-3 sm:p-4 text-center"},Fe={class:"text-2xl sm:text-3xl font-bold text-blue-600"},Ge={class:"bg-white rounded-lg shadow p-3 sm:p-4 text-center"},Ke={class:"text-2xl sm:text-3xl font-bold text-green-600"},Qe={class:"bg-white rounded-lg shadow p-3 sm:p-4 text-center"},Ye={class:"text-2xl sm:text-3xl font-bold text-amber-600"},We={class:"bg-white rounded-lg shadow p-3 sm:p-4 text-center"},Xe={class:"text-xs sm:text-sm text-gray-600 mt-1"},Ze={class:"max-w-2xl mx-auto"},et={class:"bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6"},tt={class:"flex items-center justify-between mb-4"},st={key:0,class:"text-center py-8 text-gray-500"},at={key:1,class:"space-y-2 max-h-96 overflow-y-auto"},ot={class:"flex-1 min-w-0"},lt={class:"font-medium text-gray-800 truncate"},rt={class:"text-xs text-gray-500 mt-1"},nt={class:"ml-3"},it={class:"bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col"},dt={class:"p-4 border-b flex items-center justify-between"},ut={class:"flex-1 overflow-y-auto p-4"},ct={key:0,class:"text-center py-8 text-gray-500"},ft={key:1,class:"space-y-2"},mt={class:"font-medium text-gray-800"},vt={class:"text-xs text-gray-500 mt-1"},xt={class:"p-4 border-t"},gt=["disabled"],pt={key:0},yt={key:1},bt={class:"bg-white rounded-xl sm:rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto"},ht={class:"p-4 sm:p-6"},wt={class:"mb-4"},_t={class:"px-3 py-2 bg-gray-50 rounded-lg text-sm font-mono"},kt={class:"mb-4"},St=["value"],Ct={class:"mb-6"},Rt={class:"flex gap-3"},Vt=["disabled"],Ot={key:0,class:"flex items-center justify-center"},Tt={key:1,class:"flex items-center justify-center"},It={__name:"Dashboard",setup(f){const r=we(),{logout:d,verifier:m,verifierName:j}=ke(),{isOnline:v,wasOffline:ne}=ve(),{success:S,error:u}=xe(),b=n(""),O=n(null),h=n(!1),L=n(!1),T=n(!1),D=n(!1),B=n(!1),w=n(""),N=n([]),g=n(null),p=n(""),X=n(!1),C=n([]),z=n([]),P=n({today:0,total:0}),R=ge(()=>z.value.length),ie=async()=>{var t,a,y;if(!b.value.trim())return;const s=b.value.trim();X.value=!0;try{if(v.value){const c=await q.preCheck(s);c.status&&c.data?(w.value=s,N.value=c.data.vehicles||[],g.value=null,p.value="",B.value=!0):u(c.message||"Barcode 驗證失敗")}else{const c=Ce({barcode:s,verifier_id:((t=m.value)==null?void 0:t.id)||null,verifier_name:((a=m.value)==null?void 0:a.name)||((y=m.value)==null?void 0:y.account)||"核銷人員"});S("已儲存到離線記錄，待網路恢復後自動同步"),te({id:c,barcode:s,status:"pending",created_at:new Date().toISOString()}),A(),b.value="",setTimeout(()=>{var V;(V=O.value)==null||V.focus()},100)}}catch(c){u(c.message||"預檢查失敗")}finally{X.value=!1}},de=async()=>{if(w.value){if(!g.value){u("請選擇車號");return}if(!p.value.trim()){u("請輸入司機名字");return}h.value=!0;try{const s=await q.verify(w.value,g.value,p.value.trim());s.status&&s.data?(S("核銷成功"),te({barcode:w.value,status:"synced",created_at:new Date().toISOString()}),await E(),B.value=!1,w.value="",N.value=[],g.value=null,p.value="",b.value="",setTimeout(()=>{var t;(t=O.value)==null||t.focus()},100)):u(s.message||"核銷失敗")}catch(s){u(s.message||"核銷失敗")}finally{h.value=!1}}},U=()=>{B.value=!1,w.value="",N.value=[],g.value=null,p.value="",setTimeout(()=>{var s;(s=O.value)==null||s.focus()},100)},ue=()=>{u("條碼掃描功能開發中")},A=()=>{z.value=le()},Z=async()=>{if(!v.value){u("網路未連線，無法同步");return}T.value=!0;try{const s=le();if(s.length===0){S("沒有待同步的記錄"),T.value=!1;return}const t=s.map(y=>y.barcode),a=await q.batchVerify(t);if(a.status&&a.data){const{success:y,failed:c,errors:V}=a.data;if(y>0){const H=V.map(_=>_.barcode);s.filter(_=>!H.includes(_.barcode)).forEach(_=>{re(_.id,"synced")})}c>0&&V.length>0&&V.forEach(H=>{const J=s.find(_=>_.barcode===H.barcode);J&&re(J.id,"failed")}),c===0?S(`同步完成：成功 ${y} 筆`):u(`同步完成：成功 ${y} 筆，失敗 ${c} 筆`),A(),await E(),ee()}else u(a.message||"同步失敗")}catch(s){u(s.message||"同步失敗")}finally{T.value=!1}},E=async()=>{try{if(v.value){const s=await q.getStats();s.status&&s.data&&(P.value={today:s.data.today||0,total:s.data.total||0})}}catch(s){console.error("載入統計失敗:",s)}},ee=async()=>{L.value=!0;try{A(),await E()}catch{u("載入失敗")}finally{L.value=!1}},te=s=>{C.value.unshift(s),C.value.length>20&&(C.value=C.value.slice(0,20))},se=s=>Se(s),ce=s=>({synced:"已同步",pending:"待同步",failed:"失敗"})[s]||s,fe=async()=>{await d(),r.push("/verifier/login")},ae=()=>{R.value>0&&(S("網路已恢復，正在自動同步離線記錄..."),setTimeout(()=>{Z()},1e3))};return pe(async()=>{A(),await E(),setTimeout(()=>{var s;(s=O.value)==null||s.focus()},300),window.addEventListener("network-online",ae),v.value&&ne.value&&R.value>0&&setTimeout(()=>{S(`有 ${R.value} 筆待同步記錄，點擊「待同步」按鈕進行同步`)},2e3)}),ye(()=>{window.removeEventListener("network-online",ae)}),(s,t)=>(l(),o("div",Ve,[k(v)?I("",!0):(l(),o("div",Oe,[...t[6]||(t[6]=[e("i",{class:"fas fa-wifi-slash mr-2"},null,-1),e("span",{class:"text-sm sm:text-base"},"離線模式：資料將暫存在本地",-1)])])),e("div",Te,[e("div",Ie,[e("div",je,[t[10]||(t[10]=e("div",{class:"flex items-center"},[e("h1",{class:"text-lg sm:text-xl font-bold text-gray-800"},"核銷作業")],-1)),e("div",De,[k(j)?(l(),o("div",Be,[t[7]||(t[7]=e("i",{class:"fas fa-user-circle text-gray-500"},null,-1)),e("span",Ne,i(k(j)),1)])):I("",!0),R.value>0?(l(),o("button",{key:1,onClick:t[0]||(t[0]=a=>D.value=!0),class:"relative px-3 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium hover:bg-amber-200 transition-colors"},[t[8]||(t[8]=e("i",{class:"fas fa-database mr-1"},null,-1)),x(" 待同步 "+i(R.value),1)])):I("",!0),e("button",{onClick:fe,class:"px-3 py-2 text-gray-600 hover:text-gray-800 transition-colors",title:"登出"},[...t[9]||(t[9]=[e("i",{class:"fas fa-sign-out-alt text-lg"},null,-1)])])])])])]),e("div",ze,[e("div",Ae,[e("div",Ee,[t[15]||(t[15]=e("h2",{class:"text-lg sm:text-xl font-bold text-gray-800 mb-4"},"輸入 Barcode",-1)),e("form",{onSubmit:F(ie,["prevent"]),class:"space-y-4"},[e("div",null,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[e("i",{class:"fas fa-barcode mr-2"}),x(" Barcode ")],-1)),e("div",$e,[G(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>b.value=a),type:"text",required:"",placeholder:"請輸入或掃描 barcode",autocomplete:"off",inputmode:"text",class:"flex-1 px-4 py-3.5 sm:py-3 text-base sm:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",disabled:h.value,ref_key:"barcodeInputRef",ref:O},null,8,Me),[[oe,b.value]]),e("button",{type:"button",onClick:ue,class:"px-4 py-3.5 sm:py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors touch-manipulation",title:"掃描條碼"},[...t[11]||(t[11]=[e("i",{class:"fas fa-camera text-lg"},null,-1)])])])]),e("button",{type:"submit",disabled:h.value||!b.value,class:"w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 sm:py-3 px-6 rounded-lg font-semibold text-base sm:text-sm hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg hover:shadow-xl active:scale-95 touch-manipulation"},[h.value?(l(),o("span",Pe,[...t[14]||(t[14]=[e("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),x(" 處理中... ",-1)])])):(l(),o("span",Le,[...t[13]||(t[13]=[e("i",{class:"fas fa-check-circle mr-2"},null,-1),x(" 核銷 ",-1)])]))],8,qe)],32)])]),e("div",Ue,[e("div",He,[e("div",Je,[e("div",Fe,i(P.value.today||0),1),t[16]||(t[16]=e("div",{class:"text-xs sm:text-sm text-gray-600 mt-1"},"今日核銷",-1))]),e("div",Ge,[e("div",Ke,i(P.value.total||0),1),t[17]||(t[17]=e("div",{class:"text-xs sm:text-sm text-gray-600 mt-1"},"總計",-1))]),e("div",Qe,[e("div",Ye,i(R.value),1),t[18]||(t[18]=e("div",{class:"text-xs sm:text-sm text-gray-600 mt-1"},"待同步",-1))]),e("div",We,[e("div",{class:$(["text-2xl sm:text-3xl font-bold",k(v)?"text-green-600":"text-red-600"])},[e("i",{class:$(k(v)?"fas fa-wifi":"fas fa-wifi-slash")},null,2)],2),e("div",Xe,i(k(v)?"在線":"離線"),1)])])]),e("div",Ze,[e("div",et,[e("div",tt,[t[20]||(t[20]=e("h2",{class:"text-lg sm:text-xl font-bold text-gray-800"},"最近核銷記錄",-1)),e("button",{onClick:ee,class:"px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"},[e("i",{class:$(["fas fa-sync-alt mr-1",{"animate-spin":L.value}])},null,2),t[19]||(t[19]=x(" 重整 ",-1))])]),C.value.length===0?(l(),o("div",st,[...t[21]||(t[21]=[e("i",{class:"fas fa-inbox text-4xl mb-2 opacity-50"},null,-1),e("p",null,"尚無核銷記錄",-1)])])):(l(),o("div",at,[(l(!0),o(K,null,Q(C.value,a=>(l(),o("div",{key:a.id,class:"flex items-center justify-between p-3 bg-gray-50 rounded-lg"},[e("div",ot,[e("div",lt,i(a.barcode),1),e("div",rt,i(se(a.created_at)),1)]),e("div",nt,[e("span",{class:$(["px-2 py-1 text-xs rounded-full",{"bg-green-100 text-green-700":a.status==="synced","bg-amber-100 text-amber-700":a.status==="pending","bg-red-100 text-red-700":a.status==="failed"}])},i(ce(a.status)),3)])]))),128))]))])])]),D.value?(l(),o("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4",onClick:t[3]||(t[3]=F(a=>D.value=!1,["self"]))},[e("div",it,[e("div",dt,[t[23]||(t[23]=e("h3",{class:"text-lg font-bold text-gray-800"},"待同步記錄",-1)),e("button",{onClick:t[2]||(t[2]=a=>D.value=!1),class:"p-2 text-gray-400 hover:text-gray-600"},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])])]),e("div",ut,[z.value.length===0?(l(),o("div",ct,[...t[24]||(t[24]=[e("i",{class:"fas fa-check-circle text-4xl mb-2 text-green-500"},null,-1),e("p",null,"所有記錄已同步",-1)])])):(l(),o("div",ft,[(l(!0),o(K,null,Q(z.value,a=>(l(),o("div",{key:a.id,class:"p-3 bg-gray-50 rounded-lg"},[e("div",mt,i(a.barcode),1),e("div",vt,i(se(a.created_at)),1)]))),128))]))]),e("div",xt,[e("button",{onClick:Z,disabled:T.value||!k(v),class:"w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors touch-manipulation"},[T.value?(l(),o("span",yt,"同步中...")):(l(),o("span",pt,"同步記錄"))],8,gt)])])])):I("",!0),B.value?(l(),o("div",{key:2,class:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",onClick:F(U,["self"])},[e("div",bt,[e("div",ht,[e("div",{class:"flex items-center justify-between mb-4"},[t[26]||(t[26]=e("h3",{class:"text-lg sm:text-xl font-bold text-gray-800"},"確認核銷資訊",-1)),e("button",{onClick:U,class:"p-2 text-gray-400 hover:text-gray-600 transition-colors"},[...t[25]||(t[25]=[e("i",{class:"fas fa-times text-lg"},null,-1)])])]),e("div",wt,[t[27]||(t[27]=e("label",{class:"label-base"},"Barcode",-1)),e("div",_t,i(w.value),1)]),e("div",kt,[t[29]||(t[29]=e("label",{class:"label-base"},[x(" 車號 "),e("span",{class:"text-red-500"},"*")],-1)),G(e("select",{"onUpdate:modelValue":t[4]||(t[4]=a=>g.value=a),required:"",class:"w-full px-3 py-2.5 sm:py-2 text-base sm:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[t[28]||(t[28]=e("option",{value:""},"請選擇車號",-1)),(l(!0),o(K,null,Q(N.value,a=>(l(),o("option",{key:a.id,value:a.id},i(a.front_plate)+i(a.rear_plate?" / "+a.rear_plate:"")+" ("+i(a.cleaner_name)+") ",9,St))),128))],512),[[be,g.value]])]),e("div",Ct,[t[30]||(t[30]=e("label",{class:"label-base"},[x(" 司機名字 "),e("span",{class:"text-red-500"},"*")],-1)),G(e("input",{"onUpdate:modelValue":t[5]||(t[5]=a=>p.value=a),type:"text",required:"",placeholder:"請輸入司機名字",autocomplete:"off",class:"w-full px-3 py-2.5 sm:py-2 text-base sm:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,512),[[oe,p.value]])]),e("div",Rt,[e("button",{onClick:U,class:"flex-1 px-4 py-2.5 sm:py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors"}," 取消 "),e("button",{onClick:de,disabled:h.value||!g.value||!p.value.trim(),class:"flex-1 px-4 py-2.5 sm:py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg hover:shadow-xl active:scale-95 touch-manipulation"},[h.value?(l(),o("span",Tt,[...t[32]||(t[32]=[e("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),x(" 核銷中... ",-1)])])):(l(),o("span",Ot,[...t[31]||(t[31]=[e("i",{class:"fas fa-check-circle mr-2"},null,-1),x(" 確認核銷 ",-1)])]))],8,Vt)])])])])):I("",!0),he(_e)]))}},Nt=me(It,[["__scopeId","data-v-54bf4bd6"]]);export{Nt as default};
