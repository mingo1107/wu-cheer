# 修改密碼功能測試報告

## 📋 功能概述

修改密碼功能允許已登入的使用者安全地修改其密碼。此功能需要使用者提供目前密碼以進行身份驗證，並設定新密碼。

## 🏗️ 技術實作

### 分層架構
- **Controller**: `AccountController::changePassword()`
- **Service**: `AccountService::changePassword()`
- **Repository**: `UserRepository::updatePassword()`

### API 端點
```
POST /api/account/change-password
```

### 請求參數
```json
{
    "current_password": "目前密碼",
    "new_password": "新密碼",
    "new_password_confirmation": "新密碼確認"
}
```

### 回應格式
```json
{
    "status": true,
    "message": "密碼修改成功",
    "data": {
        "message": "密碼修改成功"
    }
}
```

## 🔒 安全特性

1. **身份驗證**: 需要有效的 JWT token
2. **密碼驗證**: 必須提供正確的目前密碼
3. **密碼確認**: 新密碼需要確認
4. **密碼強度**: 最少 6 個字元
5. **密碼唯一性**: 新密碼不能與目前密碼相同
6. **交易保護**: 使用資料庫交易確保資料一致性

## 🧪 測試案例

### 測試 1: 成功修改密碼
```bash
# 1. 先登入取得 token
curl -X POST http://localhost:8000/api/account/login \
  -H 'Content-Type: application/json' \
  -d '{"email": "test@example.com", "password": "password123"}'

# 2. 使用 token 修改密碼
curl -X POST http://localhost:8000/api/account/change-password \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \
  -d '{
    "current_password": "password123",
    "new_password": "newpassword456",
    "new_password_confirmation": "newpassword456"
  }'
```

### 測試 2: 目前密碼錯誤
```bash
curl -X POST http://localhost:8000/api/account/change-password \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \
  -d '{
    "current_password": "wrongpassword",
    "new_password": "newpassword456",
    "new_password_confirmation": "newpassword456"
  }'
```

### 測試 3: 新密碼確認不一致
```bash
curl -X POST http://localhost:8000/api/account/change-password \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \
  -d '{
    "current_password": "password123",
    "new_password": "newpassword456",
    "new_password_confirmation": "differentpassword"
  }'
```

### 測試 4: 新密碼與目前密碼相同
```bash
curl -X POST http://localhost:8000/api/account/change-password \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \
  -d '{
    "current_password": "password123",
    "new_password": "password123",
    "new_password_confirmation": "password123"
  }'
```

### 測試 5: 未登入狀態
```bash
curl -X POST http://localhost:8000/api/account/change-password \
  -H 'Content-Type: application/json' \
  -d '{
    "current_password": "password123",
    "new_password": "newpassword456",
    "new_password_confirmation": "newpassword456"
  }'
```

## 📊 預期結果

| 測試案例 | 預期狀態碼 | 預期回應 |
|---------|-----------|---------|
| 成功修改密碼 | 200 | `{"status": true, "message": "密碼修改成功"}` |
| 目前密碼錯誤 | 200 | `{"status": false, "message": "目前密碼錯誤"}` |
| 密碼確認不一致 | 422 | `{"status": false, "message": "驗證失敗", "errors": {...}}` |
| 新密碼與目前密碼相同 | 200 | `{"status": false, "message": "新密碼不能與目前密碼相同"}` |
| 未登入狀態 | 401 | `{"message": "Unauthenticated."}` |

## 🔧 部署指令

### 1. 進入容器
```bash
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer"
```

### 2. 清除快取
```bash
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan config:clear"
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan route:clear"
```

### 3. 查看路由
```bash
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan route:list | grep change-password"
```

## 📝 注意事項

1. 修改密碼後，使用者需要重新登入
2. 所有密碼操作都會記錄在日誌中
3. 密碼使用 bcrypt 進行加密儲存
4. 建議定期更換密碼以維護安全性

## ✅ 功能狀態

- [x] Controller 層實作
- [x] Service 層實作
- [x] Repository 層實作
- [x] 路由設定
- [x] 參數驗證
- [x] 錯誤處理
- [x] 日誌記錄
- [x] 安全檢查
- [x] 測試案例
