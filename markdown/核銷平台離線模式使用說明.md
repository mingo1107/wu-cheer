# 核銷平台離線模式使用說明

## 📱 如何使用離線模式

### 1. 自動檢測網路狀態

系統會自動檢測網路連線狀態：
- **在線模式**：當有網路時，輸入 barcode 會直接呼叫 API 進行核銷
- **離線模式**：當沒有網路時，輸入 barcode 會自動儲存到本地（localStorage）

### 2. 離線模式指示

當系統進入離線模式時，會顯示：
- **頂部橫幅**：黃色提示「離線模式：資料將暫存在本地」
- **統計卡片**：網路狀態顯示為「離線」（紅色圖示）
- **記錄狀態**：離線記錄會標記為「待同步」（黃色標籤）

---

## 🔧 測試離線模式

### 方法一：使用瀏覽器開發者工具（推薦）

1. 開啟瀏覽器開發者工具（F12）
2. 切換到「Network」（網路）分頁
3. 選擇「Offline」（離線）模式
4. 在核銷平台輸入 barcode
5. 系統會自動切換到離線模式

### 方法二：實際斷開網路

1. 關閉 WiFi 或行動網路
2. 系統會自動檢測並切換到離線模式
3. 輸入 barcode 會儲存到本地

### 方法三：使用 Chrome DevTools 的節流功能

1. 開啟開發者工具（F12）
2. 切換到「Network」分頁
3. 點擊節流下拉選單
4. 選擇「Offline」

---

## 💾 離線記錄管理

### 查看待同步記錄

1. **自動顯示**：當有待同步記錄時，右上角會顯示「待同步 X」按鈕
2. **點擊按鈕**：點擊「待同步」按鈕會開啟離線記錄列表
3. **記錄資訊**：顯示 barcode 和輸入時間

### 同步離線記錄

#### 自動同步
- 當網路恢復時，系統會自動嘗試同步離線記錄
- 會顯示「網路已恢復，正在自動同步離線記錄...」提示

#### 手動同步
1. 確保網路已連線（狀態顯示為「在線」）
2. 點擊「待同步」按鈕
3. 在彈出的 Modal 中點擊「同步記錄」按鈕
4. 等待同步完成

---

## 📊 離線記錄狀態

### 狀態說明

- **pending（待同步）**：離線儲存的記錄，等待同步
- **synced（已同步）**：已成功同步到後端的記錄
- **failed（失敗）**：同步失敗的記錄（需要重試）

### 記錄資訊

每筆離線記錄包含：
- `id`：記錄 ID（時間戳）
- `barcode`：核銷條碼
- `verifier_id`：核銷人員 ID
- `verifier_name`：核銷人員名稱
- `created_at`：建立時間
- `status`：狀態（pending/synced/failed）

---

## 🔄 離線模式運作流程

### 1. 離線狀態下輸入 Barcode

```
使用者輸入 barcode
    ↓
系統檢測網路狀態（isOnline = false）
    ↓
儲存到 localStorage（saveOfflineRecord）
    ↓
顯示「已儲存到離線記錄，待網路恢復後自動同步」
    ↓
記錄狀態：pending（待同步）
```

### 2. 網路恢復後自動同步

```
網路恢復（isOnline = true）
    ↓
觸發 'network-online' 事件
    ↓
自動呼叫 syncOfflineRecords()
    ↓
批量上傳待同步記錄到後端
    ↓
更新記錄狀態為 synced（已同步）
```

### 3. 手動同步流程

```
點擊「待同步」按鈕
    ↓
開啟離線記錄 Modal
    ↓
點擊「同步記錄」按鈕
    ↓
檢查網路狀態
    ↓
批量上傳記錄
    ↓
更新狀態並顯示結果
```

---

## 🛠️ 開發者資訊

### 資料儲存位置

離線記錄儲存在瀏覽器的 `localStorage` 中：
- **Key**：`verifier_offline_records`
- **格式**：JSON 陣列
- **限制**：約 5-10MB（通常足夠使用）

### 查看離線記錄（開發者）

在瀏覽器 Console 中執行：

```javascript
// 查看所有離線記錄
const records = JSON.parse(localStorage.getItem('verifier_offline_records'));
console.log(records);

// 查看待同步記錄
const pending = records.filter(r => r.status === 'pending');
console.log('待同步記錄:', pending);

// 清除所有記錄（測試用）
localStorage.removeItem('verifier_offline_records');
```

### 測試離線功能

```javascript
// 模擬離線狀態
window.dispatchEvent(new Event('offline'));

// 模擬恢復網路
window.dispatchEvent(new Event('online'));
```

---

## ⚠️ 注意事項

### 1. 資料持久性
- 離線記錄儲存在 `localStorage`，清除瀏覽器資料會遺失
- 建議定期同步，避免資料遺失

### 2. 儲存空間
- `localStorage` 限制約 5-10MB
- 如果記錄過多，建議定期清理已同步的記錄

### 3. 同步時機
- 系統會在網路恢復時自動嘗試同步
- 也可以手動點擊「同步記錄」按鈕

### 4. 同步失敗處理
- 如果同步失敗，記錄狀態會保持為 `pending`
- 可以再次嘗試同步

---

## 📝 使用範例

### 場景一：正常離線使用

1. 核銷人員在無網路環境下工作
2. 輸入 barcode → 自動儲存到離線記錄
3. 繼續輸入多筆 barcode
4. 網路恢復後 → 自動同步所有記錄

### 場景二：手動同步

1. 有網路但想確認同步狀態
2. 點擊「待同步」按鈕查看記錄
3. 點擊「同步記錄」手動觸發同步
4. 確認所有記錄已同步

### 場景三：檢查記錄

1. 點擊「待同步」按鈕
2. 查看所有待同步記錄
3. 確認 barcode 和時間是否正確
4. 如有問題可清除記錄重新輸入

---

## 🔗 相關檔案

- `resources/js/pages/verifierPlatform/Dashboard.vue` - 核銷作業頁面
- `resources/js/utils/offlineStorageSimple.js` - 離線儲存工具
- `resources/js/composables/useNetworkStatus.js` - 網路狀態檢測

---

## ✅ 功能檢查清單

- [x] 自動檢測網路狀態
- [x] 離線模式下自動儲存記錄
- [x] 顯示離線提示橫幅
- [x] 顯示待同步記錄數量
- [x] 查看離線記錄列表
- [x] 手動同步功能
- [x] 自動同步功能（網路恢復時）
- [ ] 同步失敗重試機制（待實作）
- [ ] 清除已同步記錄功能（待實作）

