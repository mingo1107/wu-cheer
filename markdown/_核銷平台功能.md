# 核銷平台 - 功能規劃

## 🏗️ 系統架構

本平台採用以下分層設計模式：
Controller → Service → Repository → Model

- Controller：取得與驗證請求參數、呼叫 Service、包裝統一回應格式、處理例外、記錄操作日誌
- Service：編排商業邏輯流程、整備參數、掌管交易邊界（DB Transaction）
- Repository：封裝資料庫查詢與交易、維持資料存取的一致抽象
- 禁止事項：嚴禁在 Controller／Service 直接進行資料庫查詢與交易

---

## 📋 核銷平台功能清單

### 1. 核銷人員登入/登出
- **功能描述**：核銷平台的認證功能
- **子功能**：
  - 核銷人員登入（使用帳號和密碼）
  - 核銷人員登出
  - 取得目前核銷人員資訊
- **狀態**：✅ 已完成（登入、登出、取得資訊功能）
- **認證方式**：JWT Token（使用 `verifier` guard，與 CMS 後台分離）
- **Token 儲存**：`verifier_token`（localStorage）
- **使用者資料儲存**：`verifier_user`（localStorage）

### 2. 核銷作業
- **功能描述**：核銷土單明細的核心功能
- **核銷模式**：支援兩種模式
  - **在線模式**：即時 API 核銷
    - 當輸入核銷單的 barcode 時，即時呼叫 API 進行核銷
    - 需要網路連線
    - 核銷結果即時回傳並更新狀態
    - 適用於有穩定網路環境的場景
  - **離線模式**：暫存後批量上傳
    - 當 client 沒有網路狀態時，輸入 barcode 後暫存於 localStorage 或檔案
    - 支援前端匯出為 CSV 或 Excel 格式
    - 匯出的檔案可轉交給後勤人員在 CMS 後台上傳核銷
    - 適用於網路不穩定或無網路環境的場景
- **子功能**：
  - Barcode 輸入與驗證
  - 在線即時核銷（API 呼叫）
  - 離線暫存機制（localStorage/檔案）
  - 離線資料匯出（CSV/Excel）
  - 批量上傳核銷（CMS 後台）
- **狀態**：🔄 待開發

---

## 📁 資料夾結構

```
app/
├── Http/
│   └── Controllers/
│       └── VerifierPlatform/
│           └── VerifierAccountController.php  # 核銷人員認證
├── Services/
│   └── VerifierPlatform/
│       └── VerifierAccountService.php         # 核銷人員認證服務
├── Repositories/
│   └── VerifierRepository.php                # 核銷人員資料存取（共用）
└── Models/
    └── Verifier.php                           # 核銷人員模型（實作 JWTSubject）
```

---

## 🛣️ 路由命名規則

### 命名格式
```
{第一層}.{第二層}.{第三層}.{第四層}
```

### 各層說明
| 層級 | 說明 | 範例 |
|------|------|------|
| **第一層** | 類型識別 | `api` (API) |
| **第二層** | 平台識別 | `verifier-platform` |
| **第三層** | 功能模組 | `account` |
| **第四層** | 方法名稱 | `login`、`logout`、`me` |

---

## 🔌 API 路由

### 公開路由（不需要認證）
- `POST /api/verifier-platform/account/login` - 核銷人員登入

### 需要認證的路由（`auth:verifier` middleware）
- `POST /api/verifier-platform/account/logout` - 核銷人員登出
- `GET /api/verifier-platform/account/me` - 取得目前核銷人員資訊
- `POST /api/verifier-platform/verify` - 在線模式：即時核銷 barcode（待實作）
- `POST /api/verifier-platform/verify/batch` - 批量核銷（待實作，用於離線資料上傳）

---

## 🔐 認證機制

### Guard 配置
- **Guard 名稱**：`verifier`
- **Provider**：`verifiers`（使用 `Verifier` model）
- **認證方式**：JWT Token

### Token 管理
- **Token Key**：`verifier_token`（與 CMS 後台的 `token` 分離）
- **使用者資料 Key**：`verifier_user`（與 CMS 後台的 `user` 分離）
- **Token 過期時間**：依 `config/jwt.php` 設定

### 與 CMS 後台的區別
| 項目 | CMS 後台 | 核銷平台 |
|------|---------|---------|
| Guard | `api` | `verifier` |
| Model | `User` | `Verifier` |
| Token Key | `token` | `verifier_token` |
| User Key | `user` | `verifier_user` |
| 登入欄位 | `email` + `password` | `account` + `password` |
| API 前綴 | `/api/account/*` | `/api/verifier-platform/account/*` |

---

## 📁 前端檔案結構

```
resources/js/
├── api/
│   ├── base.js                    # 基礎 API 類（可配置 token key）
│   ├── verifierBase.js           # 核銷平台 API 實例（使用 verifier_token）
│   └── verifierAccount.js         # 核銷人員認證 API
├── composables/
│   └── useVerifierAuth.js        # 核銷人員認證 Composable
└── pages/
    └── VerifierLogin.vue          # 核銷平台登入頁面
```

---

## 🎨 UI/UX 特色

### 登入頁面
- **設計風格**：藍色系漸層背景（與 CMS 後台的琥珀色系區分）
- **表單欄位**：帳號、密碼
- **響應式設計**：支援桌面和行動裝置
- **錯誤處理**：Toast 通知顯示錯誤訊息

---

## 🔄 登入流程

1. 使用者輸入帳號和密碼
2. 前端呼叫 `POST /api/verifier-platform/account/login`
3. 後端驗證帳號、密碼和狀態
4. 後端生成 JWT token（使用 `auth('verifier')`）
5. 後端更新最後登入資訊（IP、時間）
6. 前端儲存 token 和使用者資料到 localStorage
7. 前端重導向到核銷平台首頁

---

## 🔄 核銷作業流程

### 在線模式流程

1. 核銷人員輸入 barcode
2. 前端即時呼叫 API `POST /api/verifier-platform/verify`（待實作）
3. 後端驗證 barcode 有效性
4. 後端檢查土單明細狀態（是否可核銷）
5. 後端更新明細狀態為「已核銷」
6. 後端記錄核銷人員、核銷時間
7. 前端顯示核銷成功訊息
8. 更新核銷統計資訊

### 離線模式流程

**重要說明**：由於系統部署在雲端主機，無網路狀態下無法直接存取系統。因此需要實作離線應用方案（建議使用 PWA），讓核銷人員在無網路環境下也能使用。

1. 核銷人員開啟離線應用（PWA 或 Electron 應用）
2. 選擇離線模式（或系統自動檢測網路狀態切換）
3. 輸入 barcode（無網路狀態）
4. 前端驗證 barcode 格式（離線驗證）
5. 將 barcode 資料暫存至 IndexedDB 或 localStorage
   - 儲存欄位：barcode、輸入時間、核銷人員 ID、狀態
6. 可繼續輸入多筆 barcode
7. 當有網路時，系統自動或手動觸發同步
8. **方案 A（自動同步）**：網路恢復時自動上傳至後端 API
9. **方案 B（手動匯出）**：匯出為 CSV 或 Excel 格式，轉交給後勤人員在 CMS 後台上傳

### 離線資料格式

暫存資料結構：
```json
{
  "barcode": "ED20250101001",
  "verifier_id": 1,
  "verifier_name": "張三",
  "input_time": "2025-01-16 10:30:00",
  "status": "pending"
}
```

匯出 CSV/Excel 欄位：
- Barcode
- 核銷人員
- 輸入時間
- 狀態

---

## 🚀 開發狀態

### 已完成功能
1. ✅ 核銷人員登入功能
2. ✅ 核銷人員登出功能
3. ✅ 取得核銷人員資訊
4. ✅ 前端登入頁面
5. ✅ API Base 分離（verifierBase.js）
6. ✅ 認證 Composable（useVerifierAuth.js）

### 待開發功能
1. 🔄 核銷平台首頁（Dashboard）
2. 🔄 核銷平台 Layout
3. 🔄 核銷作業功能
   - 🔄 在線模式：即時 API 核銷
   - 🔄 離線模式：暫存與匯出功能
   - 🔄 批量上傳核銷（CMS 後台）
4. 🔄 路由守衛設定

---

## 📊 功能狀態圖例

- ✅ 已完成
- 🔄 待開發
- ⚠️ 進行中
- ❌ 暫停開發

---

## 🔗 相關檔案

### 後端
- `app/Http/Controllers/VerifierPlatform/VerifierAccountController.php`
- `app/Services/VerifierPlatform/VerifierAccountService.php`
- `app/Models/Verifier.php`
- `app/Repositories/VerifierRepository.php`
- `config/auth.php`（verifier guard 和 verifiers provider）

### 前端
- `resources/js/api/verifierBase.js`
- `resources/js/api/verifierAccount.js`
- `resources/js/composables/useVerifierAuth.js`
- `resources/js/pages/VerifierLogin.vue`

### 路由
- `routes/api.php`（verifier-platform 路由群組）

### 離線方案文件
- `markdown/_核銷平台離線方案分析.md`（離線應用實作方案分析）

---

## 📝 注意事項

1. **Token 分離**：核銷平台使用獨立的 token 儲存，不會與 CMS 後台衝突
2. **認證 Guard**：使用 `auth:verifier` middleware，與 CMS 後台的 `auth:api` 分離
3. **API 前綴**：所有核銷平台 API 使用 `/api/verifier-platform/` 前綴
4. **登入欄位**：使用 `account` 而非 `email` 作為登入帳號
5. **狀態檢查**：登入時會檢查核銷人員狀態是否為 `active`
6. **離線應用方案**：由於系統部署在雲端，無網路狀態下需要實作離線應用（建議使用 PWA），詳見 `_核銷平台離線方案分析.md`
7. **離線資料儲存**：離線模式的 barcode 資料暫存於 IndexedDB（推薦）或 localStorage，key 為 `verifier_offline_data`
8. **離線資料限制**：建議設定儲存上限（IndexedDB 通常 50MB-1GB，localStorage 通常 5-10MB），避免資料過多影響效能
9. **匯出格式**：離線資料匯出支援 CSV 和 Excel 兩種格式，方便後勤人員處理
10. **批量上傳**：CMS 後台需提供批量上傳核銷功能，處理離線匯出的檔案
11. **資料驗證**：離線模式下，前端需驗證 barcode 格式，避免無效資料進入暫存
12. **網路狀態檢測**：使用 `navigator.onLine` API 檢測網路狀態，自動切換在線/離線模式
13. **背景同步**：實作 Service Worker 背景同步，網路恢復時自動上傳離線資料

