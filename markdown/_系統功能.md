# 土方石清運管理系統 - 後台功能規劃

## 🏗️ 系統架構

本專案採用以下分層設計模式：
Controller → Service → Repository → Model

- Controller：取得與驗證請求參數、呼叫 Service、包裝統一回應格式、處理例外、記錄操作日誌
- Service：編排商業邏輯流程、整備參數、掌管交易邊界（DB Transaction）
- Repository：封裝資料庫查詢與交易、維持資料存取的一致抽象
- 禁止事項：嚴禁在 Controller／Service 直接進行資料庫查詢與交易

---

## 📋 管理後台功能清單

### 1. 後台帳號管理（無限制帳號）
- **功能描述**：管理後台系統的使用者帳號
- **子功能**：
  - 使用者 CRUD 操作
  - 角色權限管理
  - 帳號狀態管理
- **狀態**：✅ 已完成（使用者管理頁面）

### 2. 登入/登出/修改密碼
- **功能描述**：系統認證相關功能
- **子功能**：
  - 使用者登入
  - 使用者登出
  - 修改密碼
- **狀態**：✅ 已完成（登入、登出、修改密碼功能）

### 3. 核銷人員管理
- **功能描述**：管理核銷小系統的登入人員
- **子功能**：
  - 核銷人員資料 CRUD（欄位：`name` 名字必填、`account` 帳號必填、`email` 選填、`phone` 電話選填、`password` 密碼、`status` 狀態、`last_login_ip` 最後登入IP、`last_login_at` 最後登入時間）
  - 公司範圍資料隔離（依 `company_id`）
  - 搜尋/排序/分頁（支援名字、帳號、Email、電話搜尋）
  - 狀態管理（啟用/停用）
- **狀態**：✅ 已完成（核銷人員管理頁面與 API）

### 4. 客戶基本資料
- **功能描述**：管理客戶的基本資訊
- **子功能**：
  - 客戶資料 CRUD（欄位：`customer_name`、`contact_person`、`phone`、`email`、`address`、`tax_id`、`status`、`notes`）
  - 公司範圍資料隔離（依 `company_id`）
  - 搜尋/排序/分頁
- **狀態**：✅ 已完成（客戶管理頁面與 API）

### 5. 清運業者管理
- **功能描述**：管理清運業者的基本資訊與車輛
- **子功能**：
  - 清運業者資料 CRUD（欄位：`cleaner_name`、`contact_person`、`phone`、`tax_id`、`status`、`notes`）
  - 車輛管理（一個清運業者可有多台車輛）
    - 車輛 CRUD（欄位：`front_plate` 車頭車號必填、`rear_plate` 車尾車號選填、`status`、`notes`）
    - 車輛數量統計顯示
  - 公司範圍資料隔離（依 `company_id`）
  - 搜尋/排序/分頁
- **狀態**：✅ 已完成（清運業者管理頁面、車輛管理 Dialog、API）

### 6. 案件維護管理
- **功能描述**：管理運輸案件的基本資訊
- **子功能**：
  - 案件建立與編輯
  - 案件狀態追蹤
  - 案件分類管理
- **狀態**：🔄 待開發

### 7. 土單資料維護管理
- **功能描述**：核心業務功能 - 土單管理
- **子功能**：
  - 土單資料 CRUD（欄位：`batch_no`、`project_name`、`flow_control_no`、`issue_date`、`issue_count`、`customer_id`、`valid_date_from`、`valid_date_to`、`carry_qty`、`carry_soil_type`、`status_desc`、`remark_desc` 等）
  - **清運業者多選**：一個土單可關聯多個清運業者（多對多關係）
  - 開立張數調整（增加/減少，減少僅限未核銷）
  - **統計資訊顯示**：在列表的「開立張數」欄位下方顯示「作廢張數/回收張數」（根據 `EarthDataDetail` 的 `status` 計算）
  - 列印功能（列印未核銷的土單明細，列印時自動更新狀態為已列印）
  - 搜尋/排序/分頁（依批號、工程名稱、開立日期等）
  - 公司範圍資料隔離（依 `company_id`）
  - **針對案件開立土單併產生 QR Code**（待開發）
    - 為特定案件建立土單
    - 自動產生 QR Code 用於追蹤
  - **列印土單（點陣式印表機）**（部分完成）
    - 支援點陣式印表機列印
    - 格式化土單列印
- **狀態**：⚠️ 進行中（基本 CRUD、多選清運業者、張數調整、統計資訊顯示、列印功能已完成）

### 8. 土單作業明細
- **功能描述**：管理土單明細的使用狀況與操作
- **子功能**：
  - 工程選擇（可搜尋，選擇後自動載入明細）
  - 明細列表顯示（Barcode、狀態、使用起迄日、列印時間、核銷人員/時間、建立時間）
  - **狀態篩選**：可依狀態篩選明細（全部/未列印/已列印/已使用/作廢/回收），狀態列表從 API 取得
  - **統計資訊顯示**：總數量/已列印數量/已核銷數量/作廢數量/回收數量
  - **批量操作**：
    - 批量作廢：選擇多筆明細進行作廢
    - 批量回收：選擇多筆明細進行回收
    - 批量更改期限：選擇多筆明細批量更新使用起迄日期
  - **列印功能**：每筆明細提供列印按鈕（僅列印未列印的明細），使用 dialog 讓使用者決定要印幾張，與土單資料維護管理的列印方式一致
  - **明細選擇機制**：作廢/回收/已核銷狀態的明細不可選擇
  - 重整功能：重新載入明細資料
  - 匯出功能：匯出明細資料（Excel）
  - 狀態管理：明細狀態包含 0:未列印、1:已列印、2:已使用、3:作廢、4:回收
- **狀態**：✅ 已完成（土單作業明細頁面與 API）

### 9. 土單回收作業
- **功能描述**：處理土單回收相關作業
- **子功能**：
  - **案件土單回收數量回填**
    - 記錄回收的土單數量
    - 更新案件狀態
- **狀態**：🔄 待開發（回收功能已整合至土單作業明細）

### 10. 土單使用統計表
- **功能描述**：提供土單使用情況的統計報表
- **子功能**：
  - **統計各案件開立土單數量/已核銷數量/廢棄數量/回收數量**
    - 開立土單數量統計
    - 已核銷數量統計
    - 廢棄數量統計
    - 回收數量統計
- **狀態**：🔄 待開發

### 11. 公告欄
- **功能描述**：系統內部公告與訊息發布
- **子功能**：
  - 公告發布/編輯/刪除/列表
  - 時間區間（`starts_at` ~ `ends_at`）
  - 前端顯示與表單皆採 24 小時制（`YYYY/MM/DD HH:mm`；`datetime-local` 搭配 `lang="en-GB"`）
  - 公司範圍資料隔離（依 `company_id`）
- **狀態**：✅ 已完成（公告管理頁面與 API）

---

## 📁 資料夾結構

```
app/
├── Http/
│   └── Controllers/
│       ├── AccountController.php      # 認證相關
│       ├── UserController.php         # 使用者管理
│       ├── VerifierController.php     # 核銷人員管理
│       ├── CustomerController.php     # 客戶管理
│       ├── CleanerController.php      # 清運業者管理（含車輛管理）
│       ├── EarthDataController.php    # 土單資料管理
│       ├── EarthDataUsageController.php # 土單作業明細管理
│       ├── CaseController.php         # 案件管理（待開發）
│       ├── ReportController.php       # 報表管理（待開發）
│       ├── AnnouncementController.php # 公告管理
│       └── CommonController.php       # 通用 API（清單、狀態列表等）
├── Services/
│   ├── AccountService.php             # 認證相關
│   ├── UserService.php               # 使用者管理
│   ├── VerifierService.php           # 核銷人員管理
│   ├── CustomerService.php           # 客戶管理
│   ├── CleanerService.php            # 清運業者管理
│   ├── CleanerVehicleService.php     # 清運業者車輛管理
│   ├── EarthDataService.php          # 土單資料管理
│   ├── EarthDataUsageService.php     # 土單作業明細管理
│   ├── CaseService.php               # 待開發
│   ├── ReportService.php             # 待開發
│   ├── AnnouncementService.php       # 公告管理
│   └── CommonService.php             # 通用服務
├── Repositories/
│   ├── UserRepository.php
│   ├── VerifierRepository.php        # 核銷人員管理
│   ├── CustomerRepository.php        # 客戶管理
│   ├── CleanerRepository.php         # 清運業者管理
│   ├── CleanerVehicleRepository.php  # 清運業者車輛管理
│   ├── EarthDataRepository.php       # 土單資料管理
│   ├── EarthDataDetailRepository.php # 土單明細管理
│   ├── CaseRepository.php            # 待開發
│   ├── ReportRepository.php           # 待開發
│   └── AnnouncementRepository.php    # 公告管理
├── Models/
│   ├── User.php
│   ├── Verifier.php                   # 核銷人員模型
│   ├── Customer.php                  # 客戶模型
│   ├── Cleaner.php                    # 清運業者模型
│   ├── CleanerVehicle.php            # 清運業者車輛模型
│   ├── EarthData.php                 # 土單資料模型
│   ├── EarthDataDetail.php          # 土單明細模型
│   ├── Case.php                      # 待開發
│   └── Announcement.php              # 公告模型
└── Formatters/
    └── ApiOutput.php
```

---

## 🛣️ 路由命名規則

### 命名格式
```
{第一層}.{第二層}.{第三層}.{第四層}
```

### 各層說明
| 層級 | 說明 | 範例 |
|------|------|------|
| **第一層** | 類型識別 | `web` (網頁)、`api` (API) |
| **第二層** | 網址路徑 | `customer`、`case`、`earth-slip` |
| **第三層** | 權限代號 | `api-index`、`api-list`、`api-export` |
| **第四層** | 方法名稱 | `index`、`show`、`store`、`update`、`delete` |

---


## 📊 系統功能
儀表板
後台管理
├── 使用者管理
├── 核銷人員管理
├── 使用者操作紀錄
資料設定
├── 客戶管理
├── 清運業者管理
├── 公告管理
土單系統
├── 土單工程管理
├── 土單作業明細（已完成）
├── 土單使用統計

## 🐳 Laradocker 容器執行方式

### 容器資訊
- **容器名稱**: `laradock-workspace-1`
- **專案路徑**: `/var/www/case/01_mingo/wu-cheer`
- **PHP 版本**: 8.4
- **Laravel 版本**: 12.x

### 常用指令

#### 1. 進入容器執行指令
```bash
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && [指令]"
```

#### 2. 常用 Laravel 指令
```bash
# 查看路由
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan route:list"

# 資料庫遷移
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan migrate"

# 建立測試資料
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan db:seed --class=TestUserSeeder"

# 啟動開發伺服器
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && php artisan serve --host=0.0.0.0 --port=8000"
```

---

## 🔐 多租戶（公司）資料隔離

- **機制**：所有讀寫操作皆依登入者的 `company_id` 篩選/注入。
- **層級**：
  - Repository：列表/查詢自動 `where('company_id', authUser.company_id)`；`create()` 自動注入 `company_id`。
  - Service：敏感資源（如公告）在 `get/update/delete` 前再做公司擁有權檢查。
- **影響模型**：`Announcement`、`Customer`、`User`、`Verifier`、`Cleaner`、`EarthData`。
- **關聯關係**：
  - `EarthData` 與 `EarthDataDetail` 為一對多關係（`hasMany`），用於統計作廢/回收張數。
  - `EarthData` 與 `Cleaner` 為多對多關係（`belongsToMany`），支援一個土單關聯多個清運業者。

---

#### 3. API 測試指令
```bash
# 登入測試
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && curl -X POST http://localhost:8000/api/account/login -H 'Content-Type: application/json' -d '{\"email\": \"test@example.com\", \"password\": \"password123\"}'"

# 登出測試
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && curl -X POST http://localhost:8000/api/account/logout -H 'Content-Type: application/json'"

# 取得帳戶資訊測試
docker exec laradock-workspace-1 bash -c "cd /var/www/case/01_mingo/wu-cheer && curl -X GET http://localhost:8000/api/account/me -H 'Content-Type: application/json'"
```

### 容器狀態檢查
```bash
# 查看運行中的容器
docker ps

# 查看容器端口映射
docker port laradock-nginx-1
docker port laradock-workspace-1
```

### 注意事項
- 專案檔案位於宿主機的 `/Users/mingotsai/Work/projects/case/01_mingo/wu-cheer`
- 容器內專案路徑為 `/var/www/case/01_mingo/wu-cheer`
- 使用 `laradock-workspace-1` 容器執行所有 Laravel 指令
- 開發伺服器預設運行在 `http://localhost:8000`

---

## 🚀 開發優先順序

### 第一階段（已完成）
1. ✅ 系統架構建立
2. ✅ 使用者認證功能（登入、登出、修改密碼）
3. ✅ 使用者管理 CRUD
4. ✅ 核銷人員管理（公司隔離、搜尋/排序/分頁）
5. ✅ 前端 Layout 設計
6. ✅ 公告欄（24 小時制、公司隔離）
7. ✅ 客戶基本資料（公司隔離、搜尋/排序/分頁）
8. ✅ 清運業者管理（公司隔離、搜尋/排序/分頁、車輛管理）
9. ✅ 土單作業明細（狀態篩選、批量操作、列印、匯出）

### 第二階段（建議優先開發）
1. 🔄 案件維護管理
2. 🔄 報表/統計頁面

### 第三階段（核心業務功能）
1. ⚠️ 土單資料維護管理（基本 CRUD、多選清運業者、張數調整、列印功能已完成）
2. ✅ 土單作業明細（狀態篩選、批量操作、列印、匯出已完成）
3. 🔄 土單使用統計表

---

## 📊 功能狀態圖例

- ✅ 已完成
- 🔄 待開發
- ⚠️ 進行中
- ❌ 暫停開發
